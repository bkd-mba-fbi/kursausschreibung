(function(e,t){e.Granite=e.Granite||{},e.Granite.HTTP=e.Granite.HTTP||{}
var n=null
e.Granite.HTTP.externalize=e.Granite.HTTP.externalize||function(t){null===n&&function(){var t=/^(?:http|https):\/\/[^\/]+(\/.*)\/(?:etc\.clientlibs|etc(\/.*)*\/clientlibs|libs(\/.*)*\/clientlibs|apps(\/.*)*\/clientlibs).*\.js(\?.*)?$/
try{if(e.CQURLInfo)n=CQURLInfo.contextPath||""
else{for(var r=document.getElementsByTagName("script"),o=0;o<r.length;o++){var i=t.exec(r[o].src)
if(i)return void(n=i[1])}n=""}}catch(e){}}()
try{0==t.indexOf("/")&&n&&0!=t.indexOf(n+"/")&&(t=n+t)}catch(e){}return t}})(this),function(e,t){if(e.Granite=e.Granite||{},!e.Granite.csrf){e.Granite.csrf={initialised:!1,refreshToken:f},u.prototype={then:function(e,t){this._handler.push({resolve:e,reject:t})},resolve:function(){this._execute("resolve",arguments)},reject:function(){this._execute("reject",arguments)},_execute:function(t,n){if(null===this._handler)throw new Error("Promise already completed.")
for(var r=0,o=this._handler.length;r<o;r++)this._handler[r][t].apply(e,n)
this.then=function(r,o){("resolve"===t?r:o).apply(e,n)},this._handler=null}}
var n,r,o=":cq_csrf_token",i="CSRF-Token",a="token.json"
f(),v(document)
var s=XMLHttpRequest.prototype.open
XMLHttpRequest.prototype.open=function(e,t){return h(t)&&"get"!==e.toLowerCase()&&(this._csrf=!0),s.apply(this,arguments)}
var c=XMLHttpRequest.prototype.send
XMLHttpRequest.prototype.send=function(t){if(this._csrf){if(r)return this.setRequestHeader(i,r),void c.apply(this,arguments)
var o=this,a=Array.prototype.slice.call(arguments)
n.then(function(e){o.setRequestHeader(i,e),c.apply(o,a)},function(){e.console&&console.error("Unable to read CSRF meta information"),c.apply(o,a)})}else c.apply(this,arguments)}
var l=HTMLFormElement.prototype.submit
if(HTMLFormElement.prototype.submit=function(){return d(this),l.apply(this,arguments)},e.Node){var p=Node.prototype.appendChild
Node.prototype.appendChild=function(){var t=p.apply(this,arguments)
if("IFRAME"===t.nodeName)try{t.contentWindow&&!t._csrf&&(t._csrf=!0,v(t.contentWindow.document))}catch(n){t.src&&t.src.length&&h(t.src)&&e.console&&console.error("Unable to attach CSRF token an iframe element on the same origin")}return t}}setInterval(function(){f()},3e5)}function u(){this._handler=[]}function h(e){var t="//"+document.location.host,n=document.location.protocol+t
return e==n||e.slice(0,n.length+1)==n+"/"||e==t||e.slice(0,t.length+1)==t+"/"||!/^(\/\/|http:|https:).*/.test(e)}function f(){n=new u
var e=new XMLHttpRequest
return e.onreadystatechange=function(){if(4===e.readyState)try{var t=JSON.parse(e.responseText)
r=t.token,n.resolve(r)}catch(t){n.reject(e.responseText)}},e.open("GET",Granite.HTTP.externalize(a),!0),e.send(),n}function d(e){var t=e.getAttribute("action")
if(!t||h(t)){var n=e.querySelector('input[name="'+o+'"]')
n||((n=document.createElement("input")).setAttribute("type","hidden"),n.setAttribute("name",o),e.appendChild(n)),n.setAttribute("value",r)}}function v(e){var t=function(e){var t=e.target
"form"===t.nodeName.toLowerCase()&&r&&d(t)}
e.addEventListener?e.addEventListener("submit",t,!0):e.attachEvent&&e.attachEvent("submit",t)}}(this)
